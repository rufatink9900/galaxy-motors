<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>APK Store Admin</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8 font-sans">

<!-- LOGIN PAGE -->
<div id="loginPage" class="max-w-md mx-auto mt-20">
  <h2 class="text-2xl font-bold mb-4 text-center">Admin Login</h2>
  <form id="loginForm" class="space-y-4">
    <input type="text" id="username" placeholder="Username" class="w-full border rounded px-3 py-2" required />
    <input type="password" id="password" placeholder="Password" class="w-full border rounded px-3 py-2" required />
    <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded">Login</button>
  </form>
</div>

<!-- ADMIN PAGE -->
<div id="adminPage" class="hidden max-w-3xl mx-auto">
  <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">APK Store Admin</h1>

  <!-- Upload Form -->
  <div class="bg-white shadow-md rounded-lg p-6 mb-8">
    <h2 class="text-2xl font-semibold mb-4">Upload APK</h2>
    <form id="uploadForm" class="space-y-4">
      <input type="text" id="title" placeholder="App title" class="w-full border rounded px-3 py-2" />
      <input type="file" id="apk" accept=".apk" class="w-full border rounded px-3 py-2" required />
      <input type="file" id="icon" accept="image/*" class="w-full border rounded px-3 py-2" />
      <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">Upload</button>
    </form>
  </div>

  <!-- Uploaded APKs -->
  <div class="bg-white shadow-md rounded-lg p-6">
    <h2 class="text-2xl font-semibold mb-4">Uploaded APKs</h2>
    <div id="apkList" class="space-y-4"></div>
  </div>
</div>

<script>
const API_URL = 'https://galaxy-store-server.onrender.com';

// ===== LOGIN =====
const loginPage = document.getElementById("loginPage");
const adminPage = document.getElementById("adminPage");
const loginForm = document.getElementById("loginForm");

loginForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;

  try {
    // !!! Важно: поле 'username' нужно переименовать в 'login' для сервера
    const res = await fetch(`${API_URL}/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ login: username, password }) // <-- исправлено
    });

    if (!res.ok) { 
      alert("Login failed: wrong username or password"); 
      return; 
    }

    const data = await res.json();
    localStorage.setItem("adminToken", data.token);

    loginPage.classList.add("hidden");
    adminPage.classList.remove("hidden");
    loadApks();

  } catch (err) { 
    console.error(err); 
    alert("Error logging in"); 
  }
});

// ===== UPLOAD APK =====
const uploadForm = document.getElementById('uploadForm');
uploadForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const token = localStorage.getItem("adminToken");
  if (!token) return alert("Not authorized");

  const formData = new FormData();
  formData.append('title', document.getElementById('title').value);
  formData.append('apk', document.getElementById('apk').files[0]);
  const iconFile = document.getElementById('icon').files[0];
  if (iconFile) formData.append('icon', iconFile);

  try {
    const res = await fetch(`${API_URL}/apks`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` },
      body: formData
    });
    if (!res.ok) throw new Error("Unauthorized or upload error");
    const data = await res.json();
    alert('Uploaded ' + data.title);
    loadApks();
  } catch (err) { 
    console.error(err); 
    alert('Error uploading APK'); 
  }
});

// ===== LOAD APKs =====
async function loadApks() {
  const token = localStorage.getItem("adminToken");
  if (!token) return;

  try {
    const res = await fetch(`${API_URL}/apks`, { headers: { 'Authorization': `Bearer ${token}` } });
    if (!res.ok) throw new Error("Unauthorized");
    const apks = await res.json();
    const container = document.getElementById('apkList');
    container.innerHTML = '';

    apks.forEach(apk => {
      const div = document.createElement('div');
      div.className = 'flex items-center justify-between border border-gray-200 rounded-lg p-4 bg-gray-50 shadow-sm';
      div.innerHTML = `
        <div class="flex items-center gap-4">
          ${apk.iconUrl ? `<img src="${apk.iconUrl}" alt="icon" class="w-12 h-12 rounded">` : ''}
          <div>
            <strong class="text-lg text-gray-800">${apk.title}</strong><br/>
            <a href="${apk.apkUrl}" target="_blank" class="text-blue-600 hover:underline">Download APK</a>
          </div>
        </div>
        <button data-id="${apk._id}" class="deleteBtn bg-red-500 text-white px-4 py-1 rounded hover:bg-red-600 transition">Delete</button>
      `;
      container.appendChild(div);
    });

    document.querySelectorAll('.deleteBtn').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('Are you sure?')) return;
        const id = btn.dataset.id;
        const res = await fetch(`${API_URL}/apks/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        alert(data.message || "Deleted");
        loadApks();
      });
    });

  } catch (err) { 
    console.error(err); 
    alert("Unauthorized! Please login again");
    localStorage.removeItem("adminToken");
    loginPage.classList.remove("hidden");
    adminPage.classList.add("hidden");
  }
}

// ===== AUTO LOGIN =====
const existingToken = localStorage.getItem("adminToken");
if (existingToken) {
  loginPage.classList.add("hidden");
  adminPage.classList.remove("hidden");
  loadApks();
}
</script>
</body>
</html>
