<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GLS Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    .app-icon {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      object-fit: cover;
    }
    
    .tablet-scroll::-webkit-scrollbar {
      width: 6px;
    }
    .tablet-scroll::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    .tablet-scroll::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 10px;
    }
    
    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .toast {
      transition: opacity 0.3s ease-in-out;
      z-index: 9999;
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background-color: white;
      padding: 2rem;
      border-radius: 1rem;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen p-4 md:p-8 font-sans">

<!-- –°–¢–†–ê–ù–ò–¶–ê –í–•–û–î–ê -->
<div id="loginPage" class="max-w-md mx-auto mt-20 fade-in">
  <div class="bg-white rounded-2xl shadow-xl p-8">
    <h2 class="text-3xl font-bold text-center">GLS ADMIN</h2>
    <p class="text-center text-gray-500 mb-8">GALAXY LIXIANG STORE</p>

    <form id="loginForm" class="space-y-5">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">–õ–æ–≥–∏–Ω</label>
        <input id="username" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω" 
               class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" 
               required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">–ü–∞—Ä–æ–ª—å</label>
        <input id="password" type="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" 
               class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" 
               required>
      </div>
      <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 rounded-lg transition shadow-md hover:shadow-lg">
        –í–æ–π—Ç–∏
      </button>
    </form>
  </div>
</div>

<!-- –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ -->
<div id="adminPage" class="hidden fade-in space-y-8 max-w-7xl mx-auto">

  <!-- –®–ê–ü–ö–ê -->
  <div class="flex flex-col sm:flex-row justify-between items-center bg-white p-6 rounded-xl shadow gap-4">
    <div>
      <h1 class="text-2xl font-bold">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
      <p class="text-gray-500">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–µ</p>
    </div>
    <div class="flex gap-3">
      <button id="refreshBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        –û–±–Ω–æ–≤–∏—Ç—å
      </button>
      <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
        –í—ã–π—Ç–∏
      </button>
    </div>
  </div>

  <!-- –§–û–†–ú–ê + –ü–õ–ê–ù–®–ï–¢ -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

    <!-- –§–û–†–ú–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø -->
    <div class="bg-white p-6 rounded-xl shadow">
      <h2 class="text-xl font-semibold mb-6 flex items-center gap-2">
        <span class="bg-green-100 text-green-700 p-2 rounded-lg">‚ûï</span>
        –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      </h2>
      
      <form id="uploadForm" class="space-y-6">
        <div>
          <label for="title" class="block text-sm font-medium text-gray-700 mb-1">
            –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è <span class="text-red-500">*</span>
          </label>
          <input id="title" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Galaxy Browser"
                 class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-green-500 focus:border-transparent transition"
                 required>
        </div>

        <textarea id="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è *"
class="w-full border px-4 py-2 rounded-lg h-24" required></textarea>

<input id="version" placeholder="–í–µ—Ä—Å–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä 1.2.0)"
class="w-full border px-4 py-2 rounded-lg">

        <div>
          <label for="packageName" class="block text-sm font-medium text-gray-700 mb-1">
            Package name <span class="text-red-500">*</span>
          </label>
          <input id="packageName" type="text" placeholder="com.example.app"
                 class="w-full border border-gray-300 rounded-lg px-4 py-2.5 font-mono text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent transition"
                 required>
          <p class="text-xs text-gray-400 mt-1">
            –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–æ–±—Ä–∞—Ç–Ω—ã–π –¥–æ–º–µ–Ω)
          </p>
        </div>

        <div>
          <label for="apk" class="block text-sm font-medium text-gray-700 mb-1">
            APK —Ñ–∞–π–ª <span class="text-red-500">*</span>
          </label>
          <input id="apk" type="file" accept=".apk"
                 class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-green-50 file:text-green-700 hover:file:bg-green-100 transition"
                 required>
          <p class="text-xs text-gray-400 mt-1">
            –¢–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã .apk, –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 100 –ú–ë
          </p>
        </div>

        <div>
          <label for="icon" class="block text-sm font-medium text-gray-700 mb-1">
            –ò–∫–æ–Ω–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          </label>
          <input id="icon" type="file" accept="image/*"
                 class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition">
          <p class="text-xs text-gray-400 mt-1">
            –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä: 512√ó512 px (PNG, JPG)
          </p>
        </div>

        <button type="submit"
                class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-medium py-3 rounded-lg transition shadow-md hover:shadow-lg flex items-center justify-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
          </svg>
          –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        </button>
      </form>
    </div>

    <!-- –ü–õ–ê–ù–®–ï–¢ -->
    <div class="bg-white p-6 rounded-xl shadow">
      <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
        <span class="bg-purple-100 text-purple-700 p-2 rounded-lg">üì±</span>
        –ü–ª–∞–Ω—à–µ—Ç (–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä)
      </h2>

      <div class="bg-black rounded-[30px] p-4 shadow-xl">
        <div class="bg-gray-100 rounded-[22px] h-[420px] overflow-y-auto p-4 tablet-scroll">
          <div id="tabletGrid" class="grid grid-cols-4 gap-4"></div>
          <div id="tabletEmpty" class="h-full flex items-center justify-center text-gray-400 hidden">
            –ù–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- –°–ü–ò–°–û–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–ô -->
  <div class="bg-white p-6 rounded-xl shadow">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
      <h2 class="text-xl font-semibold flex items-center gap-2">
        <span class="bg-blue-100 text-blue-700 p-2 rounded-lg">üì¶</span>
        –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      </h2>
      <span id="appsCount" class="bg-gray-200 px-3 py-1 rounded-full text-sm font-medium">0</span>
    </div>

    <div id="apkList" class="space-y-3"></div>

    <div id="emptyState" class="text-center text-gray-400 py-10 hidden">
      <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
      </svg>
      <p class="text-lg">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>
      <p class="text-sm">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É –≤—ã—à–µ</p>
    </div>
  </div>

</div>

<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <h2 class="text-2xl font-bold mb-6">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h2>
    
    <form id="editForm" class="space-y-4">
      <input type="hidden" id="editId">
      
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
        <input id="editTitle" type="text" class="w-full border rounded-lg px-4 py-2" required>
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">–û–ø–∏—Å–∞–Ω–∏–µ *</label>
        <textarea id="editDescription" class="w-full border rounded-lg px-4 py-2 h-24" required></textarea>
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">–í–µ—Ä—Å–∏—è</label>
        <input id="editVersion" type="text" class="w-full border rounded-lg px-4 py-2">
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Package Name *</label>
        <input id="editPackageName" type="text" class="w-full border rounded-lg px-4 py-2 font-mono" required>
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">–ù–æ–≤—ã–π APK —Ñ–∞–π–ª (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å)</label>
        <input id="editApk" type="file" accept=".apk" class="w-full">
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">–ù–æ–≤–∞—è –∏–∫–æ–Ω–∫–∞ (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å)</label>
        <input id="editIcon" type="file" accept="image/*" class="w-full">
      </div>
      
      <div class="flex gap-3 pt-4">
        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition">
          –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        </button>
        <button type="button" id="closeEditModal" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg transition">
          –û—Ç–º–µ–Ω–∞
        </button>
      </div>
    </form>
  </div>
</div>

<!-- –ò–ù–î–ò–ö–ê–¢–û–† –ó–ê–ì–†–£–ó–ö–ò -->
<div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
    <div class="loader mb-4"></div>
    <p class="text-gray-700">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
  </div>
</div>

<!-- TOAST –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø -->
<div id="toast" class="fixed bottom-4 right-4 px-6 py-3 rounded-lg text-white opacity-0 transition-all duration-300 transform translate-y-0 shadow-lg toast max-w-md z-50"></div>

<script>
  // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
  const API_URL = 'https://galaxy-store-server.onrender.com';
  
  // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
  const loginPage = document.getElementById('loginPage');
  const adminPage = document.getElementById('adminPage');
  const loginForm = document.getElementById('loginForm');
  const uploadForm = document.getElementById('uploadForm');
  const logoutBtn = document.getElementById('logoutBtn');
  const refreshBtn = document.getElementById('refreshBtn');
  const apkList = document.getElementById('apkList');
  const tabletGrid = document.getElementById('tabletGrid');
  const tabletEmpty = document.getElementById('tabletEmpty');
  const appsCount = document.getElementById('appsCount');
  const emptyState = document.getElementById('emptyState');
  const toast = document.getElementById('toast');
  const loadingOverlay = document.getElementById('loadingOverlay');
  const usernameInput = document.getElementById('username');
  const passwordInput = document.getElementById('password');
  
  // –≠–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  const editModal = document.getElementById('editModal');
  const editForm = document.getElementById('editForm');
  const editId = document.getElementById('editId');
  const editTitle = document.getElementById('editTitle');
  const editDescription = document.getElementById('editDescription');
  const editVersion = document.getElementById('editVersion');
  const editPackageName = document.getElementById('editPackageName');
  const editApk = document.getElementById('editApk');
  const editIcon = document.getElementById('editIcon');
  const closeEditModal = document.getElementById('closeEditModal');

  // –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤—ã—Ö–æ–¥–∞
  let isLoggingOut = false;
  
  // –¢–∞–π–º–µ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
  let tokenRefreshTimer = null;

  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
  function showLoading() {
    loadingOverlay.classList.remove('hidden');
    loadingOverlay.classList.add('flex');
  }

  function hideLoading() {
    loadingOverlay.classList.add('hidden');
    loadingOverlay.classList.remove('flex');
  }

  function showToast(message, isSuccess = true) {
    toast.textContent = message;
    toast.style.background = isSuccess ? '#10b981' : '#ef4444';
    toast.classList.remove('opacity-0');
    
    setTimeout(() => {
      toast.classList.add('opacity-0');
    }, 3000);
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–æ–¥–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
  function resetTokenTimer() {
    if (tokenRefreshTimer) {
      clearTimeout(tokenRefreshTimer);
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–∞ 50 –º–∏–Ω—É—Ç (—á—É—Ç—å –º–µ–Ω—å—à–µ —á–µ–º 1 —á–∞—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
    tokenRefreshTimer = setTimeout(() => {
      showToast('–°–µ—Å—Å–∏—è —Å–∫–æ—Ä–æ –∏—Å—Ç–µ—á–µ—Ç. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.', false);
    }, 50 * 60 * 1000); // 50 –º–∏–Ω—É—Ç
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
  function destroyToken() {
    // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä
    if (tokenRefreshTimer) {
      clearTimeout(tokenRefreshTimer);
      tokenRefreshTimer = null;
    }
    
    // –£–¥–∞–ª—è–µ–º —Ç–æ–∫–µ–Ω –∏–∑ localStorage
    localStorage.removeItem('adminToken');
    // –¢–∞–∫–∂–µ —É–¥–∞–ª—è–µ–º –ª–æ–≥–∏–Ω –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    localStorage.removeItem('adminLogin');
    
    // –û—á–∏—â–∞–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–ª–µ–¥—ã —Ç–æ–∫–µ–Ω–∞ –≤ –ø–∞–º—è—Ç–∏
    sessionStorage.clear();
    
    console.log('–¢–æ–∫–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–Ω–∏—á—Ç–æ–∂–µ–Ω');
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
  async function apiRequest(endpoint, options = {}) {
    const token = localStorage.getItem('adminToken');
    
    // –ï—Å–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞ –∏ –º—ã –Ω–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤—Ö–æ–¥–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
    if (!token && !loginPage.classList.contains('hidden')) {
      showToast('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', false);
      return null;
    }

    const defaultHeaders = {
      'Authorization': token ? `Bearer ${token}` : '',
      ...options.headers
    };

    try {
      showLoading();
      const response = await fetch(endpoint, {
        ...options,
        headers: defaultHeaders
      });

      if (response.status === 401) {
        // –ü—Ä–∏ 401 –æ—à–∏–±–∫–µ —É–Ω–∏—á—Ç–æ–∂–∞–µ–º —Ç–æ–∫–µ–Ω –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        destroyToken();
        showToast('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞', false);
        
        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
        adminPage.classList.add('hidden');
        loginPage.classList.remove('hidden');
        return null;
      }

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || errorData.message || '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞');
      }

      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ
      resetTokenTimer();
      
      return await response.json();
    } catch (error) {
      showToast(error.message, false);
      return null;
    } finally {
      hideLoading();
    }
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
  async function loadApks() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ª–∏ –≤—ã—Ö–æ–¥
    if (isLoggingOut) return;
    
    const token = localStorage.getItem('adminToken');
    if (!token) {
      // –ï—Å–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
      adminPage.classList.add('hidden');
      loginPage.classList.remove('hidden');
      return;
    }
    
    const data = await apiRequest(`${API_URL}/apks`);
    
    if (!data) {
      appsCount.textContent = '0';
      apkList.innerHTML = '';
      tabletGrid.innerHTML = '';
      tabletEmpty.classList.remove('hidden');
      emptyState.classList.remove('hidden');
      return;
    }

    appsCount.textContent = data.length;

    if (data.length === 0) {
      emptyState.classList.remove('hidden');
      apkList.innerHTML = '';
      tabletGrid.innerHTML = '';
      tabletEmpty.classList.remove('hidden');
      return;
    }

    emptyState.classList.add('hidden');
    tabletEmpty.classList.add('hidden');
    
    apkList.innerHTML = '';
    tabletGrid.innerHTML = '';

    data.forEach(app => {
      // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫
      const appElement = document.createElement('div');
      appElement.className = 'flex items-center justify-between gap-4 border p-3 rounded-lg hover:shadow-md transition';
      appElement.innerHTML = `
        <div class="flex items-center gap-4 flex-1 min-w-0">
          ${app.iconUrl 
            ? `<img src="${app.iconUrl}" alt="${app.title}" class="w-12 h-12 rounded-lg object-cover flex-shrink-0">` 
            : `<div class="w-12 h-12 bg-gradient-to-br from-blue-600 to-blue-700 text-white flex items-center justify-center rounded-lg text-xl font-bold flex-shrink-0">${app.title[0].toUpperCase()}</div>`
          }
          <div class="min-w-0">
            <strong class="block truncate">${app.title}</strong>
            <div class="text-xs text-gray-500 font-mono truncate">${app.packageName}</div>
            ${app.version ? `<div class="text-xs text-green-600">v${app.version}</div>` : ''}
            <div class="text-xs text-gray-400 mt-1">
              ID: ${app._id.slice(-6)}
            </div>
          </div>
        </div>
        <div class="flex gap-2 flex-shrink-0">
          <button onclick="editApp('${app._id}')" class="bg-blue-50 hover:bg-blue-100 text-blue-600 p-2 rounded-lg transition" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
            </svg>
          </button>
          <button onclick="deleteApp('${app._id}')" class="bg-red-50 hover:bg-red-100 text-red-600 p-2 rounded-lg transition" title="–£–¥–∞–ª–∏—Ç—å">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
          </button>
        </div>
      `;
      apkList.appendChild(appElement);

      // –î–æ–±–∞–≤–ª—è–µ–º –≤ –ø–ª–∞–Ω—à–µ—Ç
      const tabletItem = document.createElement('div');
      tabletItem.className = 'text-center group cursor-pointer';
      tabletItem.innerHTML = `
        ${app.iconUrl 
          ? `<img src="${app.iconUrl}" alt="${app.title}" class="app-icon mx-auto mb-1 group-hover:scale-105 transition-transform">` 
          : `<div class="app-icon bg-gradient-to-br from-blue-600 to-blue-700 text-white flex items-center justify-center mx-auto mb-1 text-xl font-bold group-hover:scale-105 transition-transform">${app.title[0].toUpperCase()}</div>`
        }
        <div class="text-xs truncate px-1">${app.title}</div>
      `;
      tabletGrid.appendChild(tabletItem);
    });
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
    resetTokenTimer();
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  window.editApp = async function(appId) {
    showLoading();
    try {
      const app = await apiRequest(`${API_URL}/apks/${appId}`);
      if (app) {
        editId.value = app._id;
        editTitle.value = app.title || '';
        editDescription.value = app.description || '';
        editVersion.value = app.version || '';
        editPackageName.value = app.packageName || '';
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –¥–ª—è —Ñ–∞–π–ª–æ–≤
        editApk.value = '';
        editIcon.value = '';
        
        editModal.classList.add('active');
      }
    } catch (error) {
      showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è', false);
    } finally {
      hideLoading();
    }
  };

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  editForm.onsubmit = async (e) => {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('title', editTitle.value.trim());
    formData.append('description', editDescription.value.trim());
    formData.append('packageName', editPackageName.value.trim());
    
    if (editVersion.value.trim()) {
      formData.append('version', editVersion.value.trim());
    }
    
    if (editApk.files[0]) {
      formData.append('apk', editApk.files[0]);
    }
    
    if (editIcon.files[0]) {
      formData.append('icon', editIcon.files[0]);
    }
    
    const token = localStorage.getItem('adminToken');
    
    try {
      showLoading();
      const response = await fetch(`${API_URL}/apks/${editId.value}`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`
        },
        body: formData
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || data.message || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
      }
      
      showToast('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
      editModal.classList.remove('active');
      await loadApks();
      
    } catch (error) {
      showToast(error.message, false);
    } finally {
      hideLoading();
    }
  };

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  closeEditModal.addEventListener('click', () => {
    editModal.classList.remove('active');
  });

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  editModal.addEventListener('click', (e) => {
    if (e.target === editModal) {
      editModal.classList.remove('active');
    }
  });

  // –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  window.deleteApp = async function(appId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ?')) {
      return;
    }

    const result = await apiRequest(`${API_URL}/apks/${appId}`, {
      method: 'DELETE'
    });

    if (result) {
      showToast('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ');
      await loadApks();
    }
  };

  // –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
  loginForm.onsubmit = async (e) => {
    e.preventDefault();
    
    const login = usernameInput.value.trim();
    const password = passwordInput.value.trim();

    if (!login || !password) {
      showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', false);
      return;
    }

    try {
      showLoading();
      const response = await fetch(`${API_URL}/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ login, password })
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || data.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
      localStorage.setItem('adminToken', data.token);
      localStorage.setItem('adminLogin', login);

      loginPage.classList.add('hidden');
      adminPage.classList.remove('hidden');

      showToast('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ');
      
      // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä —Å–µ—Å—Å–∏–∏
      resetTokenTimer();
      
      await loadApks();
    } catch (error) {
      showToast(error.message, false);
    } finally {
      hideLoading();
    }
  };

  // –ó–∞–≥—Ä—É–∑–∫–∞ APK
  uploadForm.onsubmit = async (e) => {
    e.preventDefault();

    const formData = new FormData();

    const title = document.getElementById('title').value.trim();
    const packageName = document.getElementById('packageName').value.trim();
    const description = document.getElementById('description').value.trim();
    const version = document.getElementById('version').value.trim();

    const apkFile = document.getElementById('apk').files[0];
    const iconFile = document.getElementById('icon').files[0];

    if (!title || !packageName || !apkFile || !description) {
      showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', false);
      return;
    }

    formData.append("title", title);
    formData.append("packageName", packageName);
    formData.append("description", description);
    if (version) formData.append("version", version);
    formData.append("apk", apkFile);

    if (iconFile) {
      formData.append("icon", iconFile);
    }

    showLoading();

    try {
      const token = localStorage.getItem('adminToken');
      
      const res = await fetch(`${API_URL}/apks`, {
        method: "POST",
        headers: {
          'Authorization': `Bearer ${token}`
        },
        body: formData
      });

      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.error || data.message || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
      }

      showToast("APK —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω", true);
      uploadForm.reset();
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
      resetTokenTimer();
      
      await loadApks();

    } catch (err) {
      console.error(err);
      showToast("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: " + err.message, false);
    } finally {
      hideLoading();
    }
  };

  // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã —Å –ø–æ–ª–Ω—ã–º —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–∞
  function handleLogout() {
    isLoggingOut = true;
    
    // –ü–æ–ª–Ω–æ—Å—Ç—å—é —É–Ω–∏—á—Ç–æ–∂–∞–µ–º —Ç–æ–∫–µ–Ω
    destroyToken();
    
    // –û—á–∏—â–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
    adminPage.classList.add('hidden');
    loginPage.classList.remove('hidden');
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
    passwordInput.value = '';
    usernameInput.value = '';
    
    // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–∫–∏
    apkList.innerHTML = '';
    tabletGrid.innerHTML = '';
    appsCount.textContent = '0';
    
    showToast('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
    
    setTimeout(() => {
      isLoggingOut = false;
    }, 100);
  }

  logoutBtn.addEventListener('click', (e) => {
    e.preventDefault();
    handleLogout();
  });

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞
  refreshBtn.addEventListener('click', async () => {
    await loadApks();
    showToast('–°–ø–∏—Å–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω');
  });

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  const existingToken = localStorage.getItem('adminToken');
  const savedLogin = localStorage.getItem('adminLogin');

  if (savedLogin) {
    usernameInput.value = savedLogin;
  }

  if (existingToken) {
    // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —Ç–æ–∫–µ–Ω–æ–º
    loginPage.classList.add('hidden');
    adminPage.classList.remove('hidden');
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä —Å–µ—Å—Å–∏–∏
    resetTokenTimer();
    
    loadApks().catch(() => {
      console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö, –≤–æ–∑–º–æ–∂–Ω–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥');
    });
  }

  // –ó–∞—â–∏—Ç–∞ –æ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ —á–µ—Ä–µ–∑ history
  window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
      const token = localStorage.getItem('adminToken');
      if (!token && !adminPage.classList.contains('hidden')) {
        adminPage.classList.add('hidden');
        loginPage.classList.remove('hidden');
      } else if (token) {
        // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –µ—Å—Ç—å, –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
        resetTokenTimer();
      }
    }
  });

  // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Å–±—Ä–æ—Å–∞ —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  ['click', 'keypress', 'scroll', 'mousemove'].forEach(eventType => {
    document.addEventListener(eventType, () => {
      if (localStorage.getItem('adminToken') && !adminPage.classList.contains('hidden')) {
        resetTokenTimer();
      }
    });
  });

</script>

</body>
</html>