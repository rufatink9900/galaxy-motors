{% extends "base.html" %}
{% load i18n %}
{% block title %}{{ car.name }}{% endblock %}

{% block content %}

<div class="container mx-auto px-4 py-6 sm:px-6 lg:px-8">

  <!-- Breadcrumb -->
  <nav class="mb-4">
    <ol class="flex items-center space-x-2 text-sm text-gray-600">

      <li>
        <a href="{% url 'cars:knowledge_base' %}?category={{ car.subcategory.category.id }}" 
           class="hover: transition-colors">
          {{ car.subcategory.category.name }}
        </a>
      </li>
      <li class="flex items-center">
        <svg class="w-4 h-4 mx-1" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
      </li>
      <li class="font-medium ">
        {{ car.subcategory.name }}
      </li>
    </ol>
  </nav>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">

    <!-- LEFT: Gallery -->
    <div>
      <!-- Main Image Container -->
      <div class="relative  rounded-2xl overflow-hidden shadow-sm h-80 md:h-96 lg:h-[420px] flex items-center justify-center mb-4">
        {% if car.main_image or car.additional_images.all %}
          <img id="mainImage" 
               src="{% if car.main_image %}{{ car.main_image.url }}{% endif %}" 
               alt="{{ car.name }}"
               class="w-full h-full object-contain ">
          
          <!-- Navigation Arrows -->
          {% comment %} <div class="absolute inset-0 flex items-center justify-between p-4">
            <!-- Left Arrow -->
            <button id="prevBtn" 
                    class="prev-btn bg-black bg-opacity-50 hover:bg-opacity-70 text-white rounded-full w-10 h-10 flex items-center justify-center transition-all opacity-0 group-hover:opacity-100">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
            </button>
            
            <!-- Right Arrow -->
            <button id="nextBtn" 
                    class="next-btn bg-black bg-opacity-50 hover:bg-opacity-70 text-white rounded-full w-10 h-10 flex items-center justify-center transition-all opacity-0 group-hover:opacity-100">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </button>
          </div> {% endcomment %}
          
          <!-- Image Counter -->
          {% comment %} <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-50 text-white px-3 py-1 rounded-full text-sm">
            <span id="currentIndex">1</span> / <span id="totalImages">{{ car.additional_images.all|length|add:1 }}</span>
          </div> {% endcomment %}
        {% else %}
          <div class="text-gray-400">{% trans "No image available" %}</div>
        {% endif %}
      </div>

      <!-- Thumbnails -->
      {% if car.main_image or car.additional_images.all %}
      {% comment %} <div class="flex space-x-3 overflow-x-auto pb-2 mb-4">
        {% if car.main_image %}
          <button onclick="goToImage(0)"
                  class="thumb-btn flex-shrink-0 w-16 h-16 md:w-20 md:h-20 rounded-xl overflow-hidden border-2 border-black transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black"
                  data-index="0">
            <img src="{{ car.main_image.url }}" 
                 alt="Main"
                 class="w-full h-full object-cover">
          </button>
        {% endif %}

        {% for img in car.additional_images.all %}
          <button onclick="goToImage({{ forloop.counter }})"
                  class="thumb-btn flex-shrink-0 w-16 h-16 md:w-20 md:h-20 rounded-xl overflow-hidden border-2 border-transparent hover:border-gray-300 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black"
                  data-index="{{ forloop.counter }}">
            <img src="{{ img.image.url }}" 
                 alt="Additional"
                 class="w-full h-full object-cover">
          </button>
        {% endfor %}
      </div> {% endcomment %}
      {% endif %}

    </div>

    <!-- RIGHT: Info -->
    <div>
      <!-- Category -->
      <div class="text-sm  mb-2">
        {{ car.subcategory.category.name }} • {{ car.subcategory.name }}
      </div>

      <!-- Title -->
      <h1 class="text-2xl md:text-3xl font-bold  mb-4">
        {{ car.name }}
      </h1>

      <!-- Date added -->
      <div class="text-sm  mb-4">
{{ car.created_at|date:"F d, Y" }}
      </div>

      <!-- Price -->
      {% comment %} {% if car.price %}
        <div class="bg-black text-white text-lg md:text-xl font-bold rounded-xl px-5 py-3 inline-block mb-6">
          {{ car.price }} ₼
        </div>
      {% else %}
        <div class=" mb-6">{% trans "Price on request" %}</div>
      {% endif %} {% endcomment %}

      <!-- Description -->
      <div class=" rounded-2xl p-5 md:p-6 mb-8">
        {% if car.description %}
          <div class=" leading-relaxed prose max-w-none">
            {{ car.description|linebreaks }}
          </div>
        {% else %}
          <p class=" italic">{% trans "No description available" %}</p>
        {% endif %}
      </div>

 
    </div>

  </div>

  <!-- Related cars -->
  {% if related %}
    <div class="border-t border-gray-200 mt-12 pt-12">
      <h3 class="text-2xl font-bold  mb-6">{% trans "Related cars" %}</h3>
      
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {% for item in related %}
          <a href="{% url 'cars:car_detail' item.id %}" 
             class="group block  rounded-2xl shadow-sm hover:shadow-md transition-shadow overflow-hidden border border-gray-100">
            {% if item.main_image %}
              <div class="h-40 md:h-48 overflow-hidden">
                <img src="{{ item.main_image.url }}" 
                     alt="{{ item.name }}"
                     class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
              </div>
            {% endif %}
            <div class="p-4">
              <div class="text-xs  uppercase tracking-wide mb-1">
                {{ item.subcategory.name }}
              </div>
              <h4 class="font-semibold  group-hover:text-black transition-colors line-clamp-2">
                {{ item.name }}
              </h4>
              {% if item.price %}
                <div class="mt-3 font-bold text-lg ">
                  {{ item.price }} ₼
                </div>
              {% endif %}
            </div>
          </a>
        {% endfor %}
      </div>
    </div>
  {% endif %}

</div>

<script>
  // Collect all images
  const images = [
    {% if car.main_image %}
      "{{ car.main_image.url }}",
    {% endif %}
    {% for img in car.additional_images.all %}
      "{{ img.image.url }}",
    {% endfor %}
  ];

  let currentImageIndex = 0;
  const totalImages = images.length;

  // Initialize elements
  const mainImg = document.getElementById('mainImage');
  const currentIndexSpan = document.getElementById('currentIndex');
  const totalImagesSpan = document.getElementById('totalImages');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const galleryContainer = document.querySelector('.relative');

  // Show/hide arrows on hover
  if (galleryContainer) {
    galleryContainer.classList.add('group');
  }

  // Initialize counter
  if (totalImagesSpan) {
    totalImagesSpan.textContent = totalImages;
  }

  function updateMainImage(index) {
    if (index >= 0 && index < totalImages) {
      currentImageIndex = index;
      
      // Update main image
      if (mainImg) {
        mainImg.src = images[index];
      }
      
      // Update counter
      if (currentIndexSpan) {
        currentIndexSpan.textContent = index + 1;
      }
      
      // Update active thumbnail
      document.querySelectorAll('.thumb-btn').forEach(btn => {
        const btnIndex = parseInt(btn.getAttribute('data-index'));
        if (btnIndex === index) {
          btn.classList.remove('border-transparent', 'hover:border-gray-300');
          btn.classList.add('border-black');
        } else {
          btn.classList.remove('border-black');
          btn.classList.add('border-transparent', 'hover:border-gray-300');
        }
      });
    }
  }

  function goToImage(index) {
    updateMainImage(index);
  }

  function nextImage() {
    const nextIndex = (currentImageIndex + 1) % totalImages;
    updateMainImage(nextIndex);
  }

  function prevImage() {
    const prevIndex = (currentImageIndex - 1 + totalImages) % totalImages;
    updateMainImage(prevIndex);
  }

  // Event listeners for arrows
  if (prevBtn) {
    prevBtn.addEventListener('click', prevImage);
  }
  
  if (nextBtn) {
    nextBtn.addEventListener('click', nextImage);
  }

  // Keyboard navigation
  document.addEventListener('keydown', function(e) {
    if (totalImages <= 1) return;
    
    if (e.key === 'ArrowLeft') {
      prevImage();
    } else if (e.key === 'ArrowRight') {
      nextImage();
    }
  });

  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
    if (totalImages > 0) {
      updateMainImage(0);
      
      // Show arrows if more than 1 image
      if (totalImages > 1) {
        if (prevBtn) prevBtn.style.opacity = '1';
        if (nextBtn) nextBtn.style.opacity = '1';
      }
    }
  });
</script>

{% endblock %}